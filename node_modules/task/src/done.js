exports.props = {}

exports.inject = t => {
  const prop = t.props.default
  const props = {
    done: (t, val, key, stamp) => {
      if (val === true) {
        val = stamp
      } else if (val && val.val === true) {
        val.val = val.stamp
      }
      return prop(t, val, key, stamp)
    }
  }
  t.set({ props }, false)
}

exports.done = {
  on: {
    data: {
      log: (val, stamp, t) => t.parent().get('log', {}).push('done'),
      parentDone (val, stamp, t) {
        const tasks = t.parent(2)
        if (
          tasks &&
          tasks.keys().every(key => tasks.get([key, 'done', 'compute']))
        ) {
          tasks.parent().set({ done: true }, stamp)
        }
      }
    }
  }
}
